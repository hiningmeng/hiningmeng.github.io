<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>徐柠檬的博客</title>
    <link>http://www.hiningmeng.cn/</link>
    <description>Recent content on 徐柠檬的博客</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Fri, 06 Dec 2019 15:43:19 +0800</lastBuildDate>
    
        <atom:link href="http://www.hiningmeng.cn/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Centos7下通过kubeadm安装kubernetes-v1.14.2</title>
      <link>http://www.hiningmeng.cn/post/k8s-install-centos/</link>
      <pubDate>Fri, 06 Dec 2019 15:43:19 +0800</pubDate>
      
      <guid>http://www.hiningmeng.cn/post/k8s-install-centos/</guid>
      
        <description>&lt;p&gt;本文使用的K8S版本已经不是最新，仅供参考。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://img.hixuxu.com/2019-12-06-080028.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;h3 id=&#34;hosts&#34;&gt;添加hosts文件&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;echo &amp;quot;10.40.0.201 hiningmeng-k8s1
10.40.0.202 hiningmeng-k8s2
10.40.0.203 hiningmeng-k8s3
10.40.0.204 hiningmeng-k8s4

&amp;quot; &amp;gt;&amp;gt; /etc/hosts
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;selinux&#34;&gt;关闭防火墙、selinux&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/selinux/config
setenforce 0
systemctl disable firewalld.service
systemctl stop firewalld.service
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;netbridge&#34;&gt;配置net.bridge&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;modprobe br_netfilter
echo &amp;quot;net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1&amp;quot; &amp;gt;&amp;gt; /etc/sysctl.conf
sysctl -p
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;ipvs&#34;&gt;开启IPVS&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;EOF
# !/bin/bash

modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
modprobe -- br_netfilter
EOF
chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4

yum install -y  ipvsadm ipset
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;docker&#34;&gt;安装Docker&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

yum install -y --setopt=obsoletes=0 docker-ce-18.09.2
mkdir /etc/docker

cat &amp;lt;&amp;lt; &#39;EOF&#39; &amp;gt; /etc/docker/daemon.json
{
    &amp;quot;data-root&amp;quot;: &amp;quot;/data/docker/docker&amp;quot;,
    &amp;quot;iptables&amp;quot;: false,
    &amp;quot;log-driver&amp;quot;: &amp;quot;json-file&amp;quot;,
    &amp;quot;storage-driver&amp;quot;: &amp;quot;overlay2&amp;quot;,
    &amp;quot;storage-opts&amp;quot;: [ &amp;quot;overlay2.override_kernel_check=true&amp;quot;],
    &amp;quot;log-opts&amp;quot;: {
        &amp;quot;max-size&amp;quot;: &amp;quot;100m&amp;quot;
    },
    &amp;quot;exec-opts&amp;quot;: [&amp;quot;native.cgroupdriver=systemd&amp;quot;]
}
EOF

systemctl start docker
systemctl enable docker
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;swap&#34;&gt;关闭swap&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;swapoff -a
# vim /etc/fstab
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;kubeadmkubectl&#34;&gt;安装kubeadm、kubectl&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# yum list --showduplicates | grep &#39;kubeadm\|kubectl\|kubelet&#39;

yum install -y kubelet-1.14.2 kubeadm-1.14.2 kubectl-1.14.2 --disableexcludes=kubernetes

systemctl enable kubelet
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;heading&#34;&gt;提前准备需要的镜像&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# cat docker-pull.sh
# !/bin/bash

images=(k8s.gcr.io/kube-apiserver:v1.14.2
        k8s.gcr.io/kube-controller-manager:v1.14.2
        k8s.gcr.io/kube-scheduler:v1.14.2
        k8s.gcr.io/kube-proxy:v1.14.2
        k8s.gcr.io/pause:3.1
        k8s.gcr.io/etcd:3.3.10
        k8s.gcr.io/coredns:1.3.1
        k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1)
for var in ${images[@]};do
        image=${var/k8s.gcr.io\//registry.cn-hangzhou.aliyuncs.com\/hiningmeng\/}
        docker pull ${image}
        docker tag ${image} ${var}
done

docker pull registry.cn-hangzhou.aliyuncs.com/hiningmeng/flannel:v0.11.0-amd64
docker tag registry.cn-hangzhou.aliyuncs.com/hiningmeng/flannel:v0.11.0-amd64 quay.io/coreos/flannel:v0.11.0-amd64
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;kubeadm-init-master&#34;&gt;kubeadm init 安装master&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubeadm init \
  --kubernetes-version=v1.14.2 \
  --pod-network-cidr=192.168.0.0/16 \
  --service-cidr=172.96.0.0/12 \
  --apiserver-advertise-address=10.40.0.201

mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubeadm join 10.40.0.201:6443 --token mjgmyw.kafm9jr4zczzk7z8 --discovery-token-ca-cert-hash sha256:4356ec91b61cf162cc29b76e0c118fbc7bad3a4d25bbfa4ea53ae0a9ed046f4a

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;flannel&#34;&gt;安装flannel&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

......
containers:
      - name: kube-flannel
        image: quay.io/coreos/flannel:v0.11.0-amd64
        command:
        - /opt/bin/flanneld
        args:
        - --ip-masq
        - --kube-subnet-mgr
        - --iface=eth1
......

kubectl apply -f kube-flannel.yml

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;profile&#34;&gt;配置profile&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;source &amp;lt;(kubectl completion bash) #这个是命令补全
cat &amp;lt;&amp;lt;EOF&amp;gt;&amp;gt;/etc/profile
source &amp;lt;(kubectl completion bash)
alias k=&#39;kubectl&#39;
alias ka=&#39;kubectl apply --recursive -f&#39;
alias kex=&#39;kubectl exec -i -t&#39;
alias klo=&#39;kubectl logs -f&#39;
alias kg=&#39;kubectl get&#39;
alias kd=&#39;kubectl describe&#39;
EOF

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;dns&#34;&gt;测试DNS&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl run curl --image=radial/busyboxplus:curl -it
nslookup kubernetes.default

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;ipvs1&#34;&gt;开启IPVS&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# 修改ConfigMap的kube-system/kube-proxy中的config.conf，mode: &amp;quot;ipvs&amp;quot;：
kubectl edit cm kube-proxy -n kube-system

# 之后重启各个节点上的kube-proxy pod：
kubectl get pod -n kube-system | grep kube-proxy | awk &#39;{system(&amp;quot;kubectl delete pod &amp;quot;$1&amp;quot; -n kube-system&amp;quot;)}&#39;

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;helm&#34;&gt;安装helm&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;wget https://storage.googleapis.com/kubernetes-helm/helm-v2.13.1-linux-amd64.tar.gz
tar -zxvf helm-v2.13.1-linux-amd64.tar.gz
cp linux-amd64/helm /usr/bin/

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;tillerserviceaccount&#34;&gt;准备tiller需要的ServiceAccount&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# helm-rbac-config.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: tiller
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: tiller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: tiller
    namespace: kube-system

kubectl create  -f helm-rbac-config.yaml

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;helm-init&#34;&gt;helm init&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm init --upgrade --service-account tiller --skip-refresh --tiller-image registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url http://mirror.azure.cn/kubernetes/charts/


&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;helm-repo-&#34;&gt;helm repo 可以改成阿里的，但是好久没更新了，上面使用的是微软的&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm repo remove stable
helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
helm repo update
#helm search

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;helm-ingress&#34;&gt;helm 安装ingress&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# cat ingress-nginx.yaml
controller:
  image:
    repository: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller
    tag: 0.24.1
    pullPolicy: IfNotPresent
  replicaCount: 1
  hostNetwork: true
  nodeSelector:
    node-role.kubernetes.io/edge: &#39;&#39;
  affinity:
    podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - nginx-ingress
            - key: component
              operator: In
              values:
              - controller
          topologyKey: kubernetes.io/hostname
  tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

defaultBackend:
  image:
    repository: registry.cn-hangzhou.aliyuncs.com/google_containers/defaultbackend
    tag: 1.4
    pullPolicy: IfNotPresent
  nodeSelector:
    node-role.kubernetes.io/edge: &#39;&#39;
  tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

helm install stable/nginx-ingress -n nginx-ingress --namespace ingress-nginx  -f ingress-nginx.yaml

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;helm1&#34;&gt;helm升级应用命令如下&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm upgrade -f ingress-nginx.yaml  nginx-ingress stable/nginx-ingress

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;helm2&#34;&gt;helm卸载命令&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm del --purge nginx-ingress

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;-kubernetesdashboard&#34;&gt;安装 kubernetes-dashboard&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# cat kubernetes-dashboard.yaml
image:
  repository: registry.cn-hangzhou.aliyuncs.com/hiningmeng/kubernetes-dashboard-amd64
  tag: v1.10.1
ingress:
  enabled: true
  hosts:
    - k8s.icjl.test
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: &amp;quot;true&amp;quot;
    nginx.ingress.kubernetes.io/backend-protocol: &amp;quot;HTTPS&amp;quot;
  tls:
    - secretName: icjl-test-secret
      hosts:
      - k8s.icjl.test
rbac:
  clusterAdminRole: true

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;dashboard&#34;&gt;安装dashboard&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm install stable/kubernetes-dashboard \
-n kubernetes-dashboard \
--namespace kubernetes-dashboard  \
-f kubernetes-dashboard.yaml

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;token&#34;&gt;登录token&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n kubernetes-dashboard  get secret | grep kubernetes-dashboard-token

&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;metricsserver&#34;&gt;安装metrics-server&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# cat metrics-server.yaml
args:
- --logtostderr
- --kubelet-insecure-tls
- --kubelet-preferred-address-types=InternalIP

helm install stable/metrics-server \
-n metrics-server \
--namespace monitoring \
-f metrics-server.yaml

&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
  </channel>
</rss>
